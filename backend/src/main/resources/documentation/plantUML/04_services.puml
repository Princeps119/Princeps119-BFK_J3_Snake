
@startuml
title Services – Login, Registrierung, Utilities, Token
left to right direction
skinparam classAttributeIconSize 0
skinparam packageStyle rectangle

' External stubs
class HttpExchange <<external>>
class Key <<external>>
class MongoCollection <<external>>
class Document <<external>>
class Logger <<external>>

package "services" {
  class LoginService <<singleton>> {
    - {static} logger : Logger
    - {static} instance : LoginService
    - userCollection : MongoCollection<Document>
    + {static} getInstance() : LoginService
    - LoginService()
    + logout(loginToken : TokenData) : boolean
    + checkLoginData(mail : String, password : String) : TokenData
    + getMailAndPassword(exchange : HttpExchange) : LoginData
  }

  class RegistrationService <<singleton>> {
    + {static} logger : Logger
    - {static} instance : RegistrationService
    - userCollection : MongoCollection<Document>
    + {static} getInstance() : RegistrationService
    - RegistrationService()
    + register(registerData : RegisterData) : Boolean
    - checkEmailAndPassword(registerData : RegisterData) : boolean
    + {static} hasLowerAndUpper(password : String) : boolean
  }

  class SaveGameService <<singleton>> {
    - {static} logger : Logger
    - {static} instance : SaveGameService
    - userCollection : MongoCollection<Document>
    + {static} getInstance() : SaveGameService
    - SaveGameService()
    + loadGame(exchange : HttpExchange) : SnakePositionData
    + saveSnakePosition(exchange : HttpExchange, snakeData : SnakePositionData) : boolean
  }

  class Util {
    + {static} hashPassword(password : String) : String
    + {static} validateInputs(method : String, exchange : HttpExchange) : boolean
    + {static} sendErrorResponse(exchange : HttpExchange, statusCode : int, errorMsg : String) : void
    + {static} checkLoginToken(exchange : HttpExchange, userCollection : MongoCollection<Document>) : String
    + {static} readJSON(exchange : HttpExchange, clazz : Class<T>) : T
    + {static} checkPath(path : String, exchange : HttpExchange) : String
    + {static} guessContentType(path : String) : String
    + {static} createJsonReader(exchange : HttpExchange) : JsonReader
  }

  class TokenEncrypter {
    + {static} logger : Logger
    + {static} key : Key
    + {static} encrypt(token : String) : String
    + {static} decrypt(token : String) : String
  }
  class DeletionService <<singleton>> {
    - {static} logger : Logger
    - {static} instance : DeletionService
    - userCollection : MongoCollection<Document>
    + {static} getInstance() : DeletionService
    - DeletionService()
    + deleteUser(exchange : HttpExchange) : boolean
  }
}

LoginService ..> repository.MongoRepo : getInstance(), getUserCollection(...)
LoginService o--> MongoCollection : userCollection
LoginService ..> Document
LoginService ..> services.Util : hashPassword(...), readJSON(...), sendErrorResponse(...)
LoginService ..> services.TokenEncrypter : encrypt(...), decrypt(...)
LoginService ..> data.TokenData
LoginService ..> exceptions.UserNotFoundException
LoginService ..> exceptions.EncryptionException

RegistrationService ..> repository.MongoRepo : getInstance(), getUserCollection(...)
RegistrationService o--> MongoCollection : userCollection
RegistrationService ..> Document : insertOne(...)
RegistrationService ..> services.Util : hashPassword(...)
RegistrationService ..> data.RegisterData

SaveGameService ..> repository.MongoRepo : getInstance(), getUserCollection(...)
SaveGameService o--> MongoCollection : userCollection
SaveGameService ..> Document
SaveGameService ..> services.Util : checkLoginToken(...)
SaveGameService ..> data.SnakePositionData
SaveGameService ..> exceptions.UserNotFoundException

DeletionService ..> repository.MongoRepo : getInstance(), getUserCollection(...)
DeletionService o--> MongoCollection : userCollection
DeletionService ..> services.Util : checkLoginToken(...)

Util ..> HttpExchange
Util ..> JsonReader <<external>>
Util ..> Gson <<external>>
TokenEncrypter ..> Key

note right of TokenEncrypter
AES-Schlüsselquelle:
- ENV: ENCRYPTION_KEY
- Fallback: config.properties (encryption.key)
Methoden:
- encrypt(token) : AES + Base64
- decrypt(token) : AES + Base64
end note
@enduml
